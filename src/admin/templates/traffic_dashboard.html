<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuro-Relay Traffic Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-connected { color: #28a745; }
        .status-disconnected { color: #dc3545; }
        .message-row { font-family: monospace; font-size: 12px; }
        .connection-badge { font-size: 0.9em; }
        .stats-card { min-height: 120px; }
        .message-flow {
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-brain"></i> Neuro-OS Admin
            </a>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Configs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/traffic">Traffic</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-network-wired"></i> Neuro-Relay Traffic Monitor</h1>
                    <div>
                        <button class="btn btn-success" id="startBtn" onclick="startMonitoring()">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="btn btn-danger" id="stopBtn" onclick="stopMonitoring()" disabled>
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button class="btn btn-secondary" onclick="refreshData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Status Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Monitor Status</h6>
                                <h3>
                                    <span id="monitorStatus" class="status-disconnected">
                                        <i class="fas fa-circle pulse"></i> Disconnected
                                    </span>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Active Connections</h6>
                                <h3><span id="activeConnections">0</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total Messages</h6>
                                <h3><span id="totalMessages">0</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Messages/sec</h6>
                                <h3><span id="messagesPerSec">0.0</span></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Connections -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-users"></i> Active Connections</h5>
                            </div>
                            <div class="card-body">
                                <div id="connectionsList" class="row">
                                    <div class="col-12 text-muted">No active connections</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Flow -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-stream"></i> Message Flow</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearMessages()">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="messageFlow" class="message-flow">
                                    <div class="text-muted">No messages yet...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Injection -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-syringe"></i> Manual Message Injection</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Target Connection ID</label>
                                        <input type="text" class="form-control" id="injectTarget" placeholder="e.g., neuro-os-client">
                                    </div>
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label">Message (JSON)</label>
                                        <textarea class="form-control" id="injectMessage" rows="3" placeholder='{"action": "test", "data": "hello"}'></textarea>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-warning" onclick="injectMessage()">
                                            <i class="fas fa-paper-plane"></i> Inject Message
                                        </button>
                                    </div>
                                </div>
                                <div id="injectResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let refreshInterval = null;

        // Start monitoring
        function startMonitoring() {
            fetch('/api/relay/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                        startAutoRefresh();
                        showNotification('Monitoring started', 'success');
                    } else {
                        showNotification('Failed to start monitoring: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => showNotification('Error: ' + error.message, 'danger'));
        }

        // Stop monitoring
        function stopMonitoring() {
            fetch('/api/relay/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('stopBtn').disabled = true;
                        stopAutoRefresh();
                        showNotification('Monitoring stopped', 'info');
                    }
                })
                .catch(error => showNotification('Error: ' + error.message, 'danger'));
        }

        // Auto-refresh data
        function startAutoRefresh() {
            refreshData();
            refreshInterval = setInterval(refreshData, 2000); // Refresh every 2 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Refresh all data
        function refreshData() {
            refreshStats();
            refreshConnections();
            refreshMessages();
        }

        // Refresh statistics
        function refreshStats() {
            fetch('/api/relay/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('activeConnections').textContent = data.active_connections || 0;
                    document.getElementById('totalMessages').textContent = data.total_messages || 0;
                    document.getElementById('messagesPerSec').textContent = (data.messages_per_second || 0).toFixed(2);
                    
                    const statusEl = document.getElementById('monitorStatus');
                    if (data.connected) {
                        statusEl.innerHTML = '<i class="fas fa-circle"></i> Connected';
                        statusEl.className = 'status-connected';
                    } else {
                        statusEl.innerHTML = '<i class="fas fa-circle pulse"></i> Disconnected';
                        statusEl.className = 'status-disconnected';
                    }
                })
                .catch(error => console.error('Error fetching stats:', error));
        }

        // Refresh connections list
        function refreshConnections() {
            fetch('/api/relay/connections')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('connectionsList');
                    
                    if (!data.connections || data.connections.length === 0) {
                        container.innerHTML = '<div class="col-12 text-muted">No active connections</div>';
                        return;
                    }
                    
                    container.innerHTML = data.connections.map(conn => `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="badge bg-primary connection-badge">${conn.type || 'unknown'}</span>
                                    </h6>
                                    <p class="card-text">
                                        <small>ID: <code>${conn.id}</code></small><br>
                                        <small>Messages: ${conn.message_count || 0}</small><br>
                                        <small>Connected: ${new Date(conn.connected_at).toLocaleTimeString()}</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => console.error('Error fetching connections:', error));
        }

        // Refresh message flow
        function refreshMessages() {
            fetch('/api/relay/messages?limit=50')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('messageFlow');
                    
                    if (!data.messages || data.messages.length === 0) {
                        container.innerHTML = '<div class="text-muted">No messages yet...</div>';
                        return;
                    }
                    
                    container.innerHTML = data.messages.map(msg => {
                        const time = new Date(msg.timestamp).toLocaleTimeString();
                        const msgType = msg.type || 'unknown';
                        const dataPreview = JSON.stringify(msg.data || {}).substring(0, 100);
                        
                        return `
                            <div class="message-row mb-2 pb-2 border-bottom">
                                <span class="badge bg-secondary">${time}</span>
                                <span class="badge bg-info">${msgType}</span>
                                <span class="text-muted">${dataPreview}...</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Auto-scroll to bottom
                    container.scrollTop = container.scrollHeight;
                })
                .catch(error => console.error('Error fetching messages:', error));
        }

        // Clear message flow
        function clearMessages() {
            document.getElementById('messageFlow').innerHTML = '<div class="text-muted">Messages cleared...</div>';
        }

        // Inject test message
        function injectMessage() {
            const target = document.getElementById('injectTarget').value;
            const messageStr = document.getElementById('injectMessage').value;
            const resultDiv = document.getElementById('injectResult');
            
            if (!target) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a target connection ID</div>';
                return;
            }
            
            let message;
            try {
                message = JSON.parse(messageStr || '{}');
            } catch (e) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Invalid JSON: ' + e.message + '</div>';
                return;
            }
            
            fetch('/api/relay/inject_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target, message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Message injected successfully!</div>';
                    setTimeout(() => resultDiv.innerHTML = '', 3000);
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">Failed: ' + (data.error || 'Unknown error') + '</div>';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        }

        // Show notification
        function showNotification(message, type) {
            // Simple alert for now - could be replaced with toast notifications
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Initial load
        refreshData();
    </script>
</body>
</html>
